name: Post-Release Agent Metadata Upload

on:
  release:
    types: [released]

jobs:
  update-agent-metadata:
    name: Upload agent metadata to New Relic
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Validate and extract version from release tag
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"

          # Check if tag matches vx.y.z pattern
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_valid=true" >> $GITHUB_OUTPUT
            VERSION="${TAG#v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "✓ Valid version tag: $TAG → $VERSION"
          else
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "⊘ Skipping metadata upload - tag '$TAG' does not match vx.y.z pattern"
          fi

      - name: Upload to Agent Metadata
        if: steps.version.outputs.is_valid == 'true'
        uses: newrelic/agent-metadata-action@v1.0.6
        with:
          newrelic-client-id: ${{ secrets.NEWRELIC_CLIENT_ID }}
          newrelic-private-key: ${{ secrets.NEWRELIC_PRIVATE_KEY }}
          agent-type: NRPrometheusAgent
          version: ${{ steps.version.outputs.version }}
          git-ref: ${{ github.event.release.tag_name }}
          apm-control-nr-license-key: ${{ secrets.APM_CONTROL_NR_LICENSE_KEY_STAGING }}
